<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Event Prediction App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            color: #e5e7eb;
            overflow-x: hidden;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            margin: 0 auto;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #090a0f;
            border-radius: 50%;
            box-shadow: 0 0 25px rgba(0, 191, 255, 0.3);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #9ca3af;
            background-color: rgba(31, 41, 55, 0.5);
            border: 1px solid #4b5563;
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        .tab-button:hover:not(.active) {
            background-color: rgba(55, 65, 81, 0.7);
        }
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 2rem;
            border-radius: 0.75rem;
            border: 1px solid #4b5563;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-6xl mx-auto bg-gray-900 bg-opacity-75 backdrop-blur-sm p-8 rounded-xl shadow-2xl border border-gray-700">
        <h1 class="text-4xl font-extrabold text-center text-blue-400 mb-8 tracking-wider">Transit Event Prediction</h1>

        <!-- Input Section -->
        <div class="mb-8 p-6 bg-gray-800 bg-opacity-50 rounded-lg shadow-inner border border-gray-700">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">1. Input Planetary Longitude Data</h2>
            <textarea id="chartDataInput"
                      class="w-full h-64 p-4 text-lg bg-gray-900 border-2 border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out font-mono text-gray-200"></textarea>
            <button id="generateChartsBtn"
                    class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-1 duration-300 ease-in-out text-xl">
                Generate Charts
            </button>
        </div>

        <!-- Output Section -->
        <div id="outputSection" class="hidden">
            <!-- Chart Display (for D1, D9, D10) -->
            <div class="mb-8 p-6 bg-gray-800 bg-opacity-50 rounded-lg shadow-inner border border-gray-700">
                <h2 class="text-2xl font-bold text-green-300 mb-4">2. Natal Charts</h2>
                <div class="flex justify-center space-x-4 mb-6">
                    <button id="tabD1" class="tab-button active">D-1 Chart</button>
                    <button id="tabD9" class="tab-button">D-9 Chart</button>
                    <button id="tabD10" class="tab-button">D-10 Chart</button>
                </div>
                <div class="chart-container">
                    <canvas id="chartCanvas"></canvas>
                </div>
                <div id="planetDetailsDisplay" class="mt-4 p-4 text-sm bg-gray-900 rounded-lg shadow-md min-h-[50px] transition-all duration-300 ease-in-out border border-gray-700">
                    <p class="text-gray-400">Hover over a planet on the chart to see its details here.</p>
                </div>
            </div>

            <!-- PTI Analysis Section -->
            <div class="mt-8 p-6 bg-gray-800 bg-opacity-50 rounded-lg shadow-inner border border-gray-700">
                <h2 class="text-2xl font-bold text-yellow-300 mb-4">3. Primary Time Indicator (PTI) Analysis</h2>
                <button id="findPtiBtn"
                        class="mb-6 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-1 duration-300 ease-in-out text-xl">
                    Find PTI for all Houses
                </button>
                <div id="ptiResults" class="overflow-x-auto">
                    <table class="min-w-full bg-gray-800 rounded-lg shadow overflow-hidden border border-gray-700">
                        <thead class="bg-gray-700 text-yellow-300">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">House</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">PTI Planet</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">Rule Applied</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">User Note</th>
                            </tr>
                        </thead>
                        <tbody id="ptiResultsBody" class="divide-y divide-gray-700">
                            <!-- PTI results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PTI Houses Summary Section -->
            <div id="ptiSummarySection" class="mt-8 p-6 bg-gray-800 bg-opacity-50 rounded-lg shadow-inner hidden border border-gray-700">
                <h2 class="text-2xl font-bold text-purple-300 mb-4">4. Houses & Their PTI Planets</h2>
                <div id="ptiHousesSummary" class="overflow-x-auto">
                     <table class="min-w-full bg-gray-800 rounded-lg shadow overflow-hidden border border-gray-700">
                        <thead class="bg-gray-700 text-purple-300">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">PTI Planet</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">Houses</th>
                            </tr>
                        </thead>
                        <tbody id="ptiHousesSummaryBody" class="divide-y divide-gray-700">
                            <!-- PTI houses summary will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transit Data Input Section -->
            <div class="mt-8 p-6 bg-gray-800 bg-opacity-50 rounded-lg shadow-inner border border-gray-700">
                <h2 class="text-2xl font-bold text-blue-300 mb-4">5. Input Transit Data</h2>
                <textarea id="transitDataInput"
                          class="w-full h-64 p-4 text-lg bg-gray-900 border-2 border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out font-mono text-gray-200"></textarea>
                <button id="showDualChartBtn"
                        class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-1 duration-300 ease-in-out text-xl">
                    Show Combined Natal & Transit Chart
                </button>
            </div>

            <!-- Combined Natal & Transit Chart -->
            <div id="dualChartSection" class="mt-8 p-6 bg-gray-800 bg-opacity-50 rounded-lg shadow-inner hidden border border-gray-700">
                <h2 class="text-2xl font-bold text-purple-300 mb-4">6. Combined Natal & Transit Chart</h2>
                <div class="chart-container">
                    <canvas id="dualChartCanvas"></canvas>
                </div>
                <div id="dualChartPlanetDetailsDisplay" class="mt-4 p-4 text-sm bg-gray-900 rounded-lg shadow-md min-h-[50px] transition-all duration-300 ease-in-out border border-gray-700">
                    <p class="text-gray-400">Hover over a planet on the chart to see its details here.</p>
                </div>
            </div>

            <!-- Event Timing Analysis Section -->
            <div class="mt-8 p-6 bg-gray-800 bg-opacity-50 rounded-lg shadow-inner border border-gray-700">
                <h2 class="text-2xl font-bold text-orange-300 mb-4">7. Event Timing Analysis (Transit)</h2>
                <button id="analyzeEventTimingBtn"
                        class="mb-6 w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-1 duration-300 ease-in-out text-xl">
                    Analyze Event Timing for all Houses
                </button>
                <div id="eventTimingResults" class="overflow-x-auto">
                    <table class="min-w-full bg-gray-800 rounded-lg shadow overflow-hidden border border-gray-700">
                        <thead class="bg-gray-700 text-orange-300">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">House</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">PTI</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">Event Likely?</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">Trigger Rule(s)</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="eventTimingResultsBody" class="divide-y divide-gray-700">
                            <!-- Event timing results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Strength Input Modal -->
    <div id="strengthInputModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-blue-400">Input Planet Strengths</h3>
            <p id="modalMessage">Please enter the relative strength for the following planets (0-1000):</p>
            <div id="modalStrengthInputs" class="grid grid-cols-1 gap-4"></div>
            <button id="modalConfirmBtn" class="bg-blue-600 hover:bg-blue-700">Submit Strengths</button>
        </div>
    </div>

    <script>
        // --- Constants and Mappings ---
        const SIGNS = ["Ar", "Ta", "Ge", "Cn", "Le", "Vi", "Li", "Sc", "Sg", "Cp", "Aq", "Pi"];
        const SIGN_GLYPHS = { "Ar": "♈", "Ta": "♉", "Ge": "♊", "Cn": "♋", "Le": "♌", "Vi": "♍", "Li": "♎", "Sc": "♏", "Sg": "♐", "Cp": "♑", "Aq": "♒", "Pi": "♓" };
        const PLANET_GLYPHS = { "Sun": "☉", "Moon": "☽", "Mars": "♂", "Mercury": "☿", "Jupiter": "♃", "Venus": "♀", "Saturn": "♄", "Rahu": "☊", "Ketu": "☋", "Lagna": "ASC" };
        
        const ZODIAC_SIGNS = {
            "Ar": { name: "Aries", symbol: "♈", startDegree: 0 }, "Ta": { name: "Taurus", symbol: "♉", startDegree: 30 },
            "Ge": { name: "Gemini", symbol: "♊", startDegree: 60 }, "Cn": { name: "Cancer", symbol: "♋", startDegree: 90 },
            "Le": { name: "Leo", symbol: "♌", startDegree: 120 }, "Vi": { name: "Virgo", symbol: "♍", startDegree: 150 },
            "Li": { name: "Libra", symbol: "♎", startDegree: 180 }, "Sc": { name: "Scorpio", symbol: "♏", startDegree: 210 },
            "Sg": { name: "Sagittarius", symbol: "♐", startDegree: 240 }, "Cp": { name: "Capricorn", symbol: "♑", startDegree: 270 },
            "Aq": { name: "Aquarius", symbol: "♒", startDegree: 300 }, "Pi": { name: "Pisces", symbol: "♓", startDegree: 330 }
        };
        const SIGN_LORDS = { "Ar": "Mars", "Ta": "Venus", "Ge": "Mercury", "Cn": "Moon", "Le": "Sun", "Vi": "Mercury", "Li": "Venus", "Sc": "Mars", "Sg": "Jupiter", "Cp": "Saturn", "Aq": "Saturn", "Pi": "Jupiter" };
        const PLANET_COLORS = { "Sun": "#FFD700", "Moon": "#E0E0E0", "Mars": "#FF4500", "Mercury": "#32CD32", "Jupiter": "#FF8C00", "Venus": "#87CEEB", "Saturn": "#9370DB", "Rahu": "#8A2BE2", "Ketu": "#9ACD32", "Lagna": "#FFFFFF" };
        const EXALTATION_SIGNS = { "Sun": "Ar", "Moon": "Ta", "Mars": "Cp", "Mercury": "Vi", "Jupiter": "Cn", "Venus": "Pi", "Saturn": "Li" };
        const DEBILITATION_SIGNS = { "Sun": "Li", "Moon": "Sc", "Mars": "Cn", "Mercury": "Pi", "Jupiter": "Cp", "Venus": "Vi", "Saturn": "Ar" };
        const OWN_SIGNS = { "Sun": ["Le"], "Moon": ["Cn"], "Mars": ["Ar", "Sc"], "Mercury": ["Ge", "Vi"], "Jupiter": ["Sg", "Pi"], "Venus": ["Ta", "Li"], "Saturn": ["Cp", "Aq"] };
        const PLANET_ASPECTS_RULES = { "Mars": [4, 7, 8], "Jupiter": [5, 7, 9], "Saturn": [3, 7, 10], "Rahu": [2, 5, 9], "Ketu": [] };
        const VALID_NATAL_BODIES = ["Sun", "Moon", "Mars", "Mercury", "Jupiter", "Venus", "Saturn", "Rahu", "Ketu", "Lagna"];
        const VALID_TRANSIT_BODIES = ["Lagna", "Sun", "Moon", "Mars", "Mercury", "Jupiter", "Venus", "Saturn", "Rahu", "Ketu"];
        const PTI_ELIGIBLE_PLANETS = ['Jupiter', 'Saturn', 'Rahu', 'Ketu'];
        const COMBUSTION_RANGE_DEGREES = 10;

        let parsedChartData = null;
        let parsedTransitData = null;
        let currentChartType = 'D-1';
        let ptiResultsData = [];
        let resolveModalPromise;
        let userProvidedPlanetStrengths = { "Rahu": 100, "Ketu": 100 };
        let allChartPlanetsPositions = [];
        
        const chartDataInput = document.getElementById('chartDataInput');
        const generateChartsBtn = document.getElementById('generateChartsBtn');
        const outputSection = document.getElementById('outputSection');
        const chartCanvas = document.getElementById('chartCanvas');
        const planetDetailsDisplay = document.getElementById('planetDetailsDisplay');
        const ctx = chartCanvas.getContext('2d');
        const tabD1 = document.getElementById('tabD1');
        const tabD9 = document.getElementById('tabD9');
        const tabD10 = document.getElementById('tabD10');
        const findPtiBtn = document.getElementById('findPtiBtn');
        const ptiResultsBody = document.getElementById('ptiResultsBody');
        const strengthInputModal = document.getElementById('strengthInputModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalStrengthInputs = document.getElementById('modalStrengthInputs');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const transitDataInput = document.getElementById('transitDataInput');
        const showDualChartBtn = document.getElementById('showDualChartBtn');
        const dualChartCanvas = document.getElementById('dualChartCanvas');
        const dualChartCtx = dualChartCanvas.getContext('2d');
        const dualChartPlanetDetailsDisplay = document.getElementById('dualChartPlanetDetailsDisplay');
        const dualChartSection = document.getElementById('dualChartSection');
        const analyzeEventTimingBtn = document.getElementById('analyzeEventTimingBtn');
        const eventTimingResultsBody = document.getElementById('eventTimingResultsBody');
        const ptiSummarySection = document.getElementById('ptiSummarySection');
        const ptiHousesSummaryBody = document.getElementById('ptiHousesSummaryBody');

        function parsePreciseLongitude(longitudeStr) {
            const parts = longitudeStr.match(/(\d+)\s*([A-Za-z]{2})\s*(\d+)'\s*(\d+\.\d+)"/);
            if (!parts) return null;
            const [, degreeInSign, signAbbr, minutes, seconds] = parts;
            const signInfo = ZODIAC_SIGNS[signAbbr];
            if (!signInfo) return null;
            return signInfo.startDegree + parseFloat(degreeInSign) + (parseFloat(minutes) / 60) + (parseFloat(seconds) / 3600);
        }

        function parseSimpleLongitude(longitudeStr) {
            const match = longitudeStr.match(/(\d+)([A-Za-z]+)(\d+)/);
            if (!match) return null;
            const [, degreeInSign, signAbbr, minutes] = match;
            const signIndex = SIGNS.indexOf(signAbbr);
            if (signIndex === -1) return null;
            return (signIndex * 30) + parseInt(degreeInSign) + (parseInt(minutes) / 60);
        }

        function parseChartData(inputText) {
            const lines = inputText.trim().split('\n');
            if (lines.length < 2) return null;
            const data = { 'D-1': {}, 'D-9': {}, 'D-10': {} };
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(/\s+/).filter(Boolean);
                if (parts.length < 4) continue;
                const body = parts[0];
                if (!VALID_NATAL_BODIES.includes(body)) continue;
                data['D-1'][body] = { raw: parts[1], degree: parseSimpleLongitude(parts[1]) };
                data['D-9'][body] = { raw: parts[2], degree: parseSimpleLongitude(parts[2]) };
                data['D-10'][body] = { raw: parts[3], degree: parseSimpleLongitude(parts[3]) };
            }
            return data;
        }

        function parseTransitData(inputText) {
            const lines = inputText.trim().split('\n');
            const data = {};
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const match = line.match(/^(.+?)\s+(\d+\s*[A-Za-z]{2}\s*\d+'\s*\d+\.\d+")/);
                if (match) {
                    let rawBody = match[1].trim();
                    const longitudeStr = match[2].trim();
                    let body = rawBody.replace(/\s*\(.*?\)\s*|\s*-\s*[A-Za-z]{2,3}$/g, '').trim();
                    if (VALID_TRANSIT_BODIES.includes(body)) {
                        const totalDegrees = parsePreciseLongitude(longitudeStr);
                        if (totalDegrees !== null) data[body] = { raw: longitudeStr, degree: totalDegrees };
                    }
                }
            }
            return data;
        }

        function getSignAndDegreeInSign(totalDegree) {
            const signIndex = Math.floor(totalDegree / 30) % 12;
            const degreeInSign = totalDegree % 30;
            return { sign: SIGNS[signIndex], degreeInSign: degreeInSign, signIndex: signIndex };
        }

        function getHouseOfPlanet(lagnaDegree, planetDegree) {
            const lagnaSignIndex = Math.floor(lagnaDegree / 30);
            const planetSignIndex = Math.floor(planetDegree / 30);
            return (planetSignIndex - lagnaSignIndex + 12) % 12 + 1;
        }

        function getLordOfSign(signAbbr) { return SIGN_LORDS[signAbbr]; }
        function getPlanetStrength(planet, sign) {
            if (EXALTATION_SIGNS[planet] === sign) return 2;
            if (DEBILITATION_SIGNS[planet] === sign) return -1;
            if (OWN_SIGNS[planet] && OWN_SIGNS[planet].includes(sign)) return 1;
            return 0;
        }

        function doesPlanetAspectHouse(planetName, planetHouse, targetHouse) {
            const aspects = PLANET_ASPECTS_RULES[planetName];
            if (!aspects) return false;
            return aspects.some(aspect => (planetHouse - 1 + aspect - 1 + 12) % 12 + 1 === targetHouse);
        }

        function doesPlanetAspectPlanet(aspectingPlanetName, aspectingPlanetDegree, targetPlanetDegree) {
            const aspects = PLANET_ASPECTS_RULES[aspectingPlanetName];
            if (!aspects) return false;
            const aspectingPlanetSignIndex = Math.floor(aspectingPlanetDegree / 30);
            const targetPlanetSignIndex = Math.floor(targetPlanetDegree / 30);
            return aspects.some(aspect => (aspectingPlanetSignIndex + aspect - 1 + 12) % 12 === targetPlanetSignIndex);
        }

        function setupDetailsDisplay(canvasElement, displayElement) {
            canvasElement.onmousemove = (e) => {
                const rect = canvasElement.getBoundingClientRect();
                const scaleX = canvasElement.width / rect.width;
                const scaleY = canvasElement.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                let hoveredItem = null;
                for (const item of allChartPlanetsPositions) {
                    const dist = Math.sqrt(Math.pow(mouseX - item.x, 2) + Math.pow(mouseY - item.y, 2));
                    if (dist < 15) {
                        hoveredItem = item;
                        break;
                    }
                }
                if (hoveredItem) {
                    const deg = Math.floor(hoveredItem.degreeInSign);
                    const min = Math.floor((hoveredItem.degreeInSign - deg) * 60);
                    displayElement.innerHTML = `
                        <p class="flex items-center justify-center text-lg text-gray-200">
                            <span style="color: ${PLANET_COLORS[hoveredItem.planet]}; font-size: 1.5em; margin-right: 8px;">${PLANET_GLYPHS[hoveredItem.planet]}</span>
                            <strong>${hoveredItem.planet}</strong>: ${deg}° ${min}' ${SIGN_GLYPHS[hoveredItem.sign]}
                        </p>
                        <p class="text-center text-gray-500">Chart: ${hoveredItem.chart}</p>
                    `;
                } else {
                    displayElement.innerHTML = `<p class="text-gray-400">Hover over a planet on the chart to see its details here.</p>`;
                }
            };
            canvasElement.onmouseleave = () => {
                displayElement.innerHTML = `<p class="text-gray-400">Hover over a planet on the chart to see its details here.</p>`;
            };
        }

        // --- REVISED WESTERN STYLE CHART DRAWING FUNCTION ---
        function drawWesternChart(chartData, chartLabel, highlightPtiPlanets, context, centerX, centerY, outerRadius, isCombined = false, transitData = null) {
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);
            allChartPlanetsPositions = [];
            const lagnaDegree = chartData.Lagna.degree;
            if (lagnaDegree === null) return;
            const lagnaSignIndex = Math.floor(lagnaDegree / 30);

            context.textBaseline = 'middle';
            context.textAlign = 'center';

            const houseCuspRadius = outerRadius * 0.7;
            const natalPlanetRingRadius = outerRadius * 0.55;    
            const centralCircleRadius = outerRadius * 0.15;   

            let combinedOuterRingRadius = 0;
            let combinedSignRadius = 0;
            const transitPlanetRingRadius = houseCuspRadius * 1.15; 

            if (isCombined) {
                combinedOuterRingRadius = houseCuspRadius * 1.3;
                combinedSignRadius = combinedOuterRingRadius + 25;

                context.beginPath();
                context.arc(centerX, centerY, combinedOuterRingRadius, 0, 2 * Math.PI);
                context.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                context.lineWidth = 1;
                context.stroke();
            }

            for (let i = 0; i < 12; i++) {
                const angle = (285 - i * 30) * Math.PI / 180;
                const lineEndRadius = isCombined ? combinedOuterRingRadius : houseCuspRadius;
                context.beginPath();
                context.moveTo(centerX + centralCircleRadius * Math.cos(angle), centerY + centralCircleRadius * Math.sin(angle));
                context.lineTo(centerX + lineEndRadius * Math.cos(angle), centerY + lineEndRadius * Math.sin(angle));
                context.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                context.lineWidth = 1;
                context.stroke();
            }
            
            context.beginPath();
            context.arc(centerX, centerY, centralCircleRadius, 0, 2 * Math.PI);
            context.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            context.lineWidth = 1;
            context.stroke();

            for (let i = 0; i < 12; i++) {
                const houseNumber = i + 1;
                const signIndex = (lagnaSignIndex + i) % 12;
                const signAbbr = SIGNS[signIndex];
                const signName = ZODIAC_SIGNS[signAbbr].name;
                const midAngle = (270 - i * 30) * Math.PI / 180;
                
                context.fillStyle = '#ccc';
                context.font = 'bold 14px Inter';
                const houseNumRadius = centralCircleRadius + 15;
                context.fillText(houseNumber, centerX + houseNumRadius * Math.cos(midAngle), centerY + houseNumRadius * Math.sin(midAngle));

                context.fillStyle = '#eee';
                context.font = '22px Inter';
                const signGlyphRadius = isCombined ? combinedSignRadius : (houseCuspRadius * 1.1);
                context.fillText(SIGN_GLYPHS[signAbbr], centerX + signGlyphRadius * Math.cos(midAngle), centerY + signGlyphRadius * Math.sin(midAngle));
                context.font = '12px Inter';
                context.fillText(signName, centerX + signGlyphRadius * Math.cos(midAngle), centerY + signGlyphRadius * Math.sin(midAngle) + 18);
            }

            const ascLabelAngle = (270) * Math.PI / 180;
            context.fillStyle = '#fff';
            context.font = 'bold 12px Inter';
            context.fillText('ASC', centerX + (centralCircleRadius + 30) * Math.cos(ascLabelAngle), centerY + (centralCircleRadius + 30) * Math.sin(ascLabelAngle));
            
            const placePlanets = (data, radius, label) => {
                let positions = [];
                for(const body in data) {
                    if(body === "Lagna" || !data[body] || data[body].degree === null) continue;
                    positions.push({ body: body, degree: data[body].degree });
                }
                positions.sort((a,b) => a.degree - b.degree);

                let lastAngle = -Infinity;
                let level = 0;
                positions.forEach((p) => {
                    const { signIndex, degreeInSign } = getSignAndDegreeInSign(p.degree);
                    const houseOfPlanet = (signIndex - lagnaSignIndex + 12) % 12;
                    const angle = (285 - (houseOfPlanet * 30) - degreeInSign) * Math.PI / 180;

                    if(Math.abs(angle - lastAngle) * (180/Math.PI) < 15) { level = (level + 1) % 3; } else { level = 0; }
                    const adjustedRadius = radius - (level * 18);
                    const x = centerX + adjustedRadius * Math.cos(angle);
                    const y = centerY + adjustedRadius * Math.sin(angle);
                    
                    context.fillStyle = PLANET_COLORS[p.body];
                    context.font = 'bold 20px Inter';
                    context.fillText(PLANET_GLYPHS[p.body], x, y);

                    context.font = '12px Inter';
                    context.fillText(p.body, x, y + 15);
                    
                    const { sign } = getSignAndDegreeInSign(p.degree);
                    allChartPlanetsPositions.push({ x: x, y: y, planet: p.body, sign: sign, degreeInSign: degreeInSign, chart: label });
                    lastAngle = angle;
                });
            };
            
            placePlanets(chartData, natalPlanetRingRadius, "Natal");
            if(isCombined && transitData) {
                placePlanets(transitData, transitPlanetRingRadius, "Transit");
            }

            context.beginPath();
            context.arc(centerX, centerY, houseCuspRadius, 0, 2 * Math.PI);
            context.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            context.lineWidth = 1;
            context.stroke();
        }
        
        function drawSingleChart(chartData, chartName, highlightPtiPlanets = []) {
            const baseSize = 800;
            chartCanvas.width = baseSize;
            chartCanvas.height = baseSize;
            const centerX = chartCanvas.width / 2;
            const centerY = chartCanvas.height / 2;
            const outerRadius = baseSize / 2 - 40;
            drawWesternChart(chartData, chartName, highlightPtiPlanets, ctx, centerX, centerY, outerRadius);
        }
        
        function drawDualChart(natalData, transitData) {
            const baseSize = 800;
            dualChartCanvas.width = baseSize;
            dualChartCanvas.height = baseSize;
            const centerX = dualChartCanvas.width / 2;
            const centerY = dualChartCanvas.height / 2;
            const outerRadius = baseSize / 2 - 20;
            drawWesternChart(natalData, "Combined", [], dualChartCtx, centerX, centerY, outerRadius, true, transitData);
        }

        async function promptForPlanetStrengths(planetsToAskFor) {
            return new Promise(resolve => {
                resolveModalPromise = resolve;
                modalStrengthInputs.innerHTML = planetsToAskFor.map(planet => `
                    <div class="flex items-center justify-between p-2 border border-gray-600 rounded-md">
                        <label for="strength-${planet}" class="font-medium">${planet}:</label>
                        <input type="number" id="strength-${planet}" data-planet="${planet}"
                               class="w-24 p-1 bg-gray-800 border border-gray-500 rounded-md text-right"
                               min="0" max="1000" value="${userProvidedPlanetStrengths[planet] || ''}" placeholder="e.g., 500">
                    </div>`).join('');
                modalConfirmBtn.onclick = () => {
                    let allValid = true;
                    modalStrengthInputs.querySelectorAll('input').forEach(input => {
                        const value = parseInt(input.value);
                        if (isNaN(value) || value < 0 || value > 1000) { allValid = false; input.style.borderColor = 'red'; } 
                        else { userProvidedPlanetStrengths[input.dataset.planet] = value; input.style.borderColor = ''; }
                    });
                    if (allValid) { strengthInputModal.classList.remove('show'); resolve(); }
                };
                strengthInputModal.classList.add('show');
            });
        }

        async function findPTIForHouse(houseNumber, d1Chart, d9Chart) {
            const d1LagnaDegree = d1Chart.Lagna.degree;
            const houseSignIndex = (Math.floor(d1LagnaDegree / 30) + houseNumber - 1) % 12;
            const houseSignAbbr = SIGNS[houseSignIndex];
            const houseLord = getLordOfSign(houseSignAbbr);
            
            const getStrength = p => userProvidedPlanetStrengths[p] || 0;
            const handleCandidates = async (candidates, rule) => {
                if (candidates.length === 0) return null;
                if (candidates.length === 1) return { pti: candidates[0], rule: rule, userNote: "" };
                const toAsk = candidates.filter(p => !userProvidedPlanetStrengths[p]);
                if (toAsk.length > 0) await promptForPlanetStrengths(toAsk);
                candidates.sort((a,b) => getStrength(b) - getStrength(a));
                return { pti: candidates[0], rule: rule, userNote: "Strongest by numerical strength" };
            };

            let result = 
                await handleCandidates(PTI_ELIGIBLE_PLANETS.filter(p => d1Chart[p] && getHouseOfPlanet(d1LagnaDegree, d1Chart[p].degree) === houseNumber), "Rule 1: Planet in House") ||
                await handleCandidates(PTI_ELIGIBLE_PLANETS.filter(p => d1Chart[p] && doesPlanetAspectHouse(p, getHouseOfPlanet(d1LagnaDegree, d1Chart[p].degree), houseNumber)), "Rule 2: Planet Aspects House") ||
                (PTI_ELIGIBLE_PLANETS.includes(houseLord) ? { pti: houseLord, rule: "Rule 3: House Lord", userNote: "" } : null) ||
                await handleCandidates(PTI_ELIGIBLE_PLANETS.filter(p => d1Chart[p] && d1Chart[houseLord] && getHouseOfPlanet(d1LagnaDegree, d1Chart[p].degree) === getHouseOfPlanet(d1LagnaDegree, d1Chart[houseLord].degree)), "Rule 4: Planet Conjunct Lord") ||
                await handleCandidates(PTI_ELIGIBLE_PLANETS.filter(p => d1Chart[p] && d1Chart[houseLord] && doesPlanetAspectPlanet(p, d1Chart[p].degree, d1Chart[houseLord].degree)), "Rule 5: Planet Aspects Lord") ||
                await handleCandidates(PTI_ELIGIBLE_PLANETS.filter(p => d9Chart[p] && getSignAndDegreeInSign(d9Chart[p].degree).sign === houseSignAbbr), "Rule 6: Planet in D9 Sign");

            return result || { pti: "No PTI found", rule: "N/A", userNote: "" };
        }

        async function calculateAllPTIs() {
            if (!parsedChartData) return;
            ptiResultsData = [];
            for (let i = 1; i <= 12; i++) {
                const result = await findPTIForHouse(i, parsedChartData['D-1'], parsedChartData['D-9']);
                ptiResultsData.push({ house: i, ...result });
            }
            displayPTIResults(ptiResultsData);
            displayPTIHousesSummary(ptiResultsData);
            if (currentChartType === 'D-1') {
                const ptiPlanets = ptiResultsData.map(r => r.pti).filter(p => p !== "No PTI found");
                drawSingleChart(parsedChartData['D-1'], 'D-1 Chart', ptiPlanets);
            }
        }

        async function analyzeEventTiming(d1Chart, transitChart, ptiResults) {
            const results = [];
            for (let i = 1; i <= 12; i++) {
                const ptiEntry = ptiResults.find(p => p.house === i);
                const pti = ptiEntry ? ptiEntry.pti : "No PTI found";
                let likely = "❌ No", rules = [], details = [];
                
                if (pti !== "No PTI found" && transitChart[pti]) {
                    const natalLagna = d1Chart.Lagna.degree;
                    const transitPtiDegree = transitChart[pti].degree;
                    const houseSign = SIGNS[(Math.floor(natalLagna / 30) + i - 1) % 12];
                    const transitPtiSign = getSignAndDegreeInSign(transitPtiDegree).sign;
                    const transitPtiHouse = getHouseOfPlanet(natalLagna, transitPtiDegree);
                    
                    if (transitPtiSign === houseSign || doesPlanetAspectHouse(pti, transitPtiHouse, i)) {
                        likely = "✅ Yes"; rules.push("Rule 1");
                        details.push(`Transit ${pti} influences house ${i}.`);
                    } else {
                        const slowMovers = ["Jupiter", "Saturn", "Rahu", "Ketu"].filter(p => p !== pti);
                        const influencingSlowMovers = slowMovers.filter(smp => transitChart[smp] && (getSignAndDegreeInSign(transitChart[smp].degree).sign === houseSign || doesPlanetAspectHouse(smp, getHouseOfPlanet(natalLagna, transitChart[smp].degree), i)));
                        if (influencingSlowMovers.length >= 2) {
                            likely = "✅ Yes"; rules.push("Rule 2");
                            details.push(`${influencingSlowMovers.join(', ')} influence house ${i}.`);
                        } else {
                            const houseLord = getLordOfSign(houseSign);
                            if (d1Chart[houseLord] && transitPtiSign === getSignAndDegreeInSign(d1Chart[houseLord].degree).sign) {
                                likely = "✅ Yes"; rules.push("Rule 3");
                                details.push(`Transit ${pti} conjuncts natal ${houseLord}.`);
                            }
                        }
                    }
                    
                    let challenges = [];
                    if ([6,8,12].includes(transitPtiHouse)) challenges.push(`${pti} in Trika house`);
                    if (transitChart.Sun && Math.abs(transitPtiDegree - transitChart.Sun.degree) % 360 < COMBUSTION_RANGE_DEGREES) challenges.push(`${pti} is combust`);
                    if (DEBILITATION_SIGNS[pti] === transitPtiSign) challenges.push(`${pti} is debilitated`);
                    if (challenges.length > 0) {
                        rules.push("Rule 4");
                        details.push(`Challenges: ${challenges.join(', ')}.`);
                    }
                }
                results.push({ house: i, pti, eventLikely: likely, triggerRules: rules.join(', ') || '-', details: details.join('; ') || 'No active influence.' });
            }
            return results;
        }

        generateChartsBtn.addEventListener('click', () => {
            parsedChartData = parseChartData(chartDataInput.value);
            if (parsedChartData && parsedChartData['D-1'] && parsedChartData['D-1'].Lagna) {
                outputSection.classList.remove('hidden');
                drawSingleChart(parsedChartData['D-1'], 'D-1 Chart');
                ptiResultsBody.innerHTML = ''; eventTimingResultsBody.innerHTML = '';
                ['tabD1', 'tabD9', 'tabD10'].forEach((t,i) => document.getElementById(t).classList.toggle('active', i===0));
                currentChartType = 'D-1';
            } else {
                alert("Please enter valid natal chart data, including Lagna for D-1 chart.");
            }
        });
        
        ['tabD1', 'tabD9', 'tabD10'].forEach(tabId => {
            document.getElementById(tabId).addEventListener('click', () => {
                currentChartType = `D-${tabId.substring(3)}`;
                ['tabD1', 'tabD9', 'tabD10'].forEach(t => document.getElementById(t).classList.toggle('active', t === tabId));
                if (parsedChartData) {
                    const ptiPlanets = ptiResultsData.map(r => r.pti).filter(p => p !== "No PTI found");
                    drawSingleChart(parsedChartData[currentChartType], `${currentChartType} Chart`, ptiPlanets);
                }
            });
        });

        findPtiBtn.addEventListener('click', calculateAllPTIs);

        showDualChartBtn.addEventListener('click', () => {
            parsedTransitData = parseTransitData(transitDataInput.value);
            if (parsedChartData && parsedTransitData && parsedTransitData.Lagna) {
                dualChartSection.classList.remove('hidden');
                drawDualChart(parsedChartData['D-1'], parsedTransitData);
            } else {
                alert("Please generate natal charts first and ensure valid transit data is provided.");
            }
        });

        analyzeEventTimingBtn.addEventListener('click', async () => {
            if (!parsedChartData || !parsedTransitData || ptiResultsData.length === 0) {
                alert("Please generate natal charts, input transit data, and find PTI for all houses first."); return;
            }
            const results = await analyzeEventTiming(parsedChartData['D-1'], parsedTransitData, ptiResultsData);
            displayEventTimingResults(results);
        });

        function displayPTIResults(results) {
            ptiResultsBody.innerHTML = results.map(r => `
                <tr class="hover:bg-gray-700">
                    <td class="py-3 px-4">${r.house}</td> <td class="py-3 px-4">${r.pti}</td>
                    <td class="py-3 px-4">${r.rule}</td> <td class="py-3 px-4">${r.userNote}</td>
                </tr>`).join('');
        }

        function displayPTIHousesSummary(results) {
            const ptiMap = {};
            results.forEach(r => { if (r.pti !== "No PTI found") { if (!ptiMap[r.pti]) ptiMap[r.pti] = []; ptiMap[r.pti].push(r.house); }});
            ptiHousesSummaryBody.innerHTML = Object.entries(ptiMap).map(([pti, houses]) => `
                <tr class="hover:bg-gray-700">
                    <td class="py-3 px-4">${pti}</td> <td class="py-3 px-4">${houses.join(', ')}</td>
                </tr>`).join('');
            ptiSummarySection.classList.remove('hidden');
        }

        function displayEventTimingResults(results) {
            eventTimingResultsBody.innerHTML = results.map(r => `
                <tr class="hover:bg-gray-700">
                    <td class="py-3 px-4">${r.house}</td> <td class="py-3 px-4">${r.pti}</td>
                    <td class="py-3 px-4">${r.eventLikely}</td> <td class="py-3 px-4">${r.triggerRules}</td>
                    <td class="py-3 px-4">${r.details}</td>
                </tr>`).join('');
        }

        window.addEventListener('resize', () => {
            if (parsedChartData) {
                const ptiPlanets = ptiResultsData.map(r => r.pti).filter(p => p !== "No PTI found");
                drawSingleChart(parsedChartData[currentChartType], `${currentChartType} Chart`, ptiPlanets);
                if (!dualChartSection.classList.contains('hidden') && parsedTransitData) {
                    drawDualChart(parsedChartData['D-1'], parsedTransitData);
                }
            }
        });

        chartDataInput.value = `Body     D‑1      D‑9      D‑10
Sun      24Ge05   0Aq47    18Vi09
Moon     23Pi56   29Ge15   12Aq09
Mars     26Ge32   25Aq22   23Vi04
Mercury  20Cn14   22Vi20   19Li32
Jupiter  21Cp27   4Ar31    17Li06
Venus    10Ta20   13Ar24   9Cn19
Saturn   28Li02   10Cn19   26Ta04
Rahu     17Ar51   28Vi23   24Sc14
Ketu     17Li51   28Pi23   24Ta14
Lagna    29Ge32   25Pi17   29Vi03`;

        transitDataInput.value = `Body      Longitude       Nakshatra Pada Rasi Navamsa
Lagna     5 Aq 52' 27.06" Dhan      4    Aq   Sc
Sun - BK  12 Cn 33' 41.16" Push      3    Cn   Li
Moon - MK 10 Vi 36' 09.09" Hast      1    Vi   Ar
Mars - DK  0 Vi 39' 07.02" UPha      2    Vi   Cp
Mercury (R) - AmK 16 Cn 33' 19.31" Push      4    Cn   Sc
Jupiter - AK  17 Ge 00' 41.52" Ardr      4    Ge   Pi
Venus - PK   4 Ge 02' 07.63" Mrig      4    Ge   Sc
Saturn (R) - PiK  7 Pi 30' 25.58" UBha      2    Pi   Vi
Rahu - GK   26 Aq 11' 53.96" PBha      2    Aq   Ta
Ketu      26 Le 11' 53.96" PPha      4    Le   Sc`;

        setupDetailsDisplay(chartCanvas, planetDetailsDisplay);
        setupDetailsDisplay(dualChartCanvas, dualChartPlanetDetailsDisplay);
    </script>
</body>
</html>

